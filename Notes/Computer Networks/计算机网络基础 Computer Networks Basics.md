# 计算机网络基础 Computer Networks Basics

## 概述

### ISP 互联网服务提供商

- ISP从互联网管理机构获得IP地址，拥有通信线路及路由器等联网设备，个人或机构向ISP购买服务就可接入互联网。

- 互联网是一种多层次ISP结构，ISP根据覆盖面积的大小分为第一层ISP、区域ISP和接入ISP。互联网交换点 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。

- IXP 互联网交换中心：不同电信运营商间为连通各自网络而建立的集中交换平台，一般由第三方中立运营。

  ![IXP & ISP](<https://camo.githubusercontent.com/b5bdb659b78196ccfa88909e4b9c8263d2af2cb0/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f385f323030313535303831323033383139302e706e67>)

  

### 主机间的通讯方式

- Client - Server (C/S)：客户是服务的请求方，服务器是服务的提供方。
- P2P 对等网络：每个参与者具有同等的能力，可以发起一个通信会话。[详细](https://blog.csdn.net/ljianhui/article/details/16911151)

### 时延

时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

- 排队时延：分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。
- 处理时延：主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。
- 传输时延：主机或路由器传输数据帧所需要的时间。
- 传播时延：电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。

## 体系结构

![layers](<https://camo.githubusercontent.com/307487dbeaf00492335d1f034529100e4f368a43/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f66356434306230312d616266322d343335652d396365372d3738383963343162326661362e6a7067>)

### The 5-Layer Model (the TCP/IP Model)

- **应用层 Process & Application Layer**：为特定应用程序提供数据传输服务，数据单位为报文。协议代表：<u>HTTP、DNS、WWW</u> 等。

- **传输层 Transport Layer**：为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。Unix把"主机+端口"称作Socket，由此产生两种协议：<u>TCP</u> 提供完整性服务，<u>UDP</u> 提供及时性服务。

  ​	**传输控制协议 TCP**，提供面向连接的可靠数据传输服务，数据单位为报文段；

  ​	**用户数据报协议 UDP**，提供无连接的尽最大努力的数据传输服务，数据单位为用户数据报。

- **网络层 Network Layer**：基于网络寻址协议为主机提供数据传输服务（而传输层为主机中的进程提供数据传输服务）。把传输层传递下来的报文段或用户数据报封装成分组。协议代表：<u>IP、IPX、RIP、OSPF</u>等。

- **数据链路层 Data Link Layer**：为同一链路主机提供数据传输（网络层针对的是主机间数据传输，而主机之间可以有很多链路）。数据链路层把网络层传下来的分组封装成帧。协议代表：<u>Eternet、MAC地址</u>等。

- **物理层 Physical Layer**：在传输媒介上传输数据比特流（0和1的电信号）。尽可能屏蔽传输媒介和通信手段的差异，使数据链路层感觉不到这些差异。协议代表：<u>电缆、光纤、双绞线、无线电波</u>等。

### The 7-Layer Model (the OSI Model)

OSI是Open System Interconnect的缩写，其将TCP的**应用层**拆分为三层功能：

- **会话层 Session Layer**：建立和管理进程间会话。
- **表示层 Presentation Layer**：数据压缩、加密以及数据描述，如ASCII，Unicode，BMP编解码。
- **应用层 Application Layer**：计算机操作及界面管理。



## 1 物理层 Physical Layer

###通信方式

根据信息在传输线上的传送方向，分为以下三种通信方式：

- 单工通信：单向传输；
- 半双工通信：双向交替传输；
- 全双工通信：双向同时传输。

### 带通调制

- 带通调制把数字信号转换为模拟信号。



##2 链路层 Data Link Layer

链路(link)是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

### 基本要素

#####封装成帧

- 数据链路层传输的是帧。

- 封装成帧就是在一段数据的前后分别添加**首部**和**尾部**，就构成了一个帧。

  ![封装成帧](<https://camo.githubusercontent.com/6c2bd984d53bd59f2d120e8de63b68978f1b8256/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f39633630373933662d356537662d343533622d383431332d3335383930633234616263342e706e67>)

#####透明传输

- 为了防止帧的数据部分出现混淆首部/尾部的字符 `SOH` 和 `EOT` ，传输前插入转义字符 `ESC` 标明。接收端再将该转义字符删除。
- 如果转义字符 `ESC` 本身也出现在数据部分，为了防止混淆，会在其前面再插入一个同样的字符。接收端只删除两个连续转义字符中前面的那个。

#####差错检验

- 数据链路层广泛使用循环冗余检验(CRC)来检查比特差错。

#####信道

- 点对点信道：一对一通信。不会发生碰撞，较简单。使用 PPP 协议进行控制。
- 广播信道：一对多通信，所有节点在同一个广播信道上发送数据，需要专门的控制方法进行协调，避免碰撞。主要有两种控制方法，一是**信道复用技术**，一是 **CSMA/CD 协议**。

#####信道复用

- 频分复用：所有主机在相同时间占用**不同频率**的带宽资源。
- 时分复用：所有主机在**不同时间**占用相同频率的带宽资源。
- 统计时分复用：时分复用的改进。不固定每个用户在时分复用帧中的位置，一旦有数据则集中起来组成统计时分复用帧发送。

- 波分复用：光的频分复用。因此习惯上用波长而非频率来表示所使用的光载波。

- 码分复用：为每个用户分配 m bit 的码片，并且所有的码片正交。接收端通过对数据进行内积运算确定用户身份。

  

### 通信协议

#####CSMA/CD 

- Carrier Sense Multiple Access with Collision Detection，意为载波监听多点接入/碰撞检测。
- 多点接入说明是总线型网络，计算机连接在一根总线上，技术核心是“载波监听”和“碰撞检测”。

- 思想上源于1-persistent CSMA。在其基础上加入了碰撞检测机制。

- 具体工作机制：

  **节点发送数据前持续监听信道，一旦发现信道空闲则立刻发送数据。同时也持续监听信道，探测是否别的节点当前也在发送数据。**

  **若传输过程中未检测到别的节点传输，则传输成功。成功后，节点须等待帧间间隔IFG (interframe gap) 时间后，才可以进行下一次传输。**

- 记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就知道是否发生碰撞，称 2τ 为**争用期**。经过争用期后还未检测到碰撞，则肯定这次发送不发生碰撞。
- 碰撞时站点要停止发送，等待一段时间再发送。此时间采用**截断二进制指数退避算法**确定。

#####PPP

- PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

- PPP 的帧格式：

  ![PPP帧](<https://camo.githubusercontent.com/5242826de22946936d5116633d8976b4fcac5202/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f36333031303733372d326362342d343866332d393939662d3039313934343831623232372e706e67>)

  - F 字段为帧的定界符
  - A 和 C 字段暂时没有意义
  - FCS 字段是使用 CRC 的检验序列
  - 信息部分的长度不超过 1500

#####MAC地址

- 是链路层地址，长 6 bytes (48 bits)，用于唯一标识网络适配器。
- 一台主机拥有多少个网络适配器就有多少个 MAC 地址。

#####Ethernet

- 以太网是一种星型拓扑结构局域网。

- 目前以太网使用交换机，交换机是一种链路层设备，它不会发生碰撞，能根据 MAC 地址进行存储转发。

- 以太网帧格式：

  - **类型** ：标记上层使用的协议；
  - **数据** ：长度在 46-1500 之间，如果太小则需要填充；
  - **FCS** ：帧检验序列，使用的是 CRC 检验方法；

  [![img](https://camo.githubusercontent.com/3b68f07549d9dde06f0525b71810cdfcfd6294e2/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f34323066346463302d366334622d343836632d616665612d3237343239393031343436322e706e67)](https://camo.githubusercontent.com/3b68f07549d9dde06f0525b71810cdfcfd6294e2/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f34323066346463302d366334622d343836632d616665612d3237343239393031343436322e706e67)

#####交换机

- 交换表中存储 MAC 地址到接口的映射。
- 交换机具有自学习能力，学习的是交换表的内容。因此交换机是即插即用的，不需要手动配置交换表内容。

#####虚拟局域网

- 建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。



##3 网络层 Network Layer

网络层是整个互联网的核心，应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

网络层提供[路由](https://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1)和寻址的功能，使两终端系统能互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。由于TCP/IP协议体系中的网络层功能由IP协议规定和实现，故又称IP层。网络层也是[TCP/IP](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)模型中的网际层。

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

### IP报文

IP报文是在网络层传输的数据单元，也叫IP数据报。

![IP 数据报](<https://raw.githubusercontent.com/DuskPiper/ProjChengdu-Coder-Notes/master/Illustration/IP%20%E6%95%B0%E6%8D%AE%E6%8A%A5.png>)

- **版本** : 有 4（IPv4）和 6（IPv6）两个值；
- **首部长度** : 占 4 位，最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为首部固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
- **区分服务** : 用来获得更好的服务，一般情况下不使用。
- **总长度** : 包括首部长度和数据部分长度。
- **生存时间** ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
- **协议** ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
- **首部检验和** ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- **标识** : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- **片偏移** : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

### IP地址编址

IP 地址的编址方式经历了三个历史阶段：

- 分类：由两部分组成，网络号和主机号。其中不同分类具有不同的网络号长度，并且固定。
- 子网划分：在主机号中取一部分作子网号，从而把两级 IP 地址划分为三级 IP 地址。须配置子网掩码。
- **无分类**：无分类编址 CIDR 使用网络前缀和主机号进行编码，网络前缀长度可按需变化。记法上采用在完整 IP 地址后加上网络前缀长度的方法。

###地址解析协议 ARP

- ARP 实现由 IP 地址得到 MAC 地址。是通过解析网路层地址来找寻数据链路层地址(MAC地址)的、一个在网络协议包中极其重要的网络传输协议。
- 每个主机都有一个 ARP 高速缓存，存有本局域网上的各主机和路由器 IP 地址到 MAC 地址的映射表。
- 在[IPv6](https://zh.wikipedia.org/wiki/IPv6)中[邻居发现协议](https://zh.wikipedia.org/wiki/%E9%82%BB%E5%B1%85%E5%8F%91%E7%8E%B0%E5%8D%8F%E8%AE%AE)（NDP）用于代替地址解析协议。

### 网际控制报文协议 ICMP

- ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。
- 它封装在 IP 数据报中，是TCP/IP协议族的一个子协议，但不属于高层协议。

#####Ping

- Ping 是 ICMP 的一个重要应用，用于测试两主机间的连通性。
- 向目的主机发送 ICMP Echo 请求报文，目的主机收到后发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算数据包往返时间以及丢包率。

#####Traceroute

- Traceroute 是 ICMP 的一个重要应用，用于跟踪一个分组从源点到终点的路径。
- 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

### 虚拟专用网 VPN

- 由于 IP 地址紧缺，一个机构分配的 IP 地址数往往远小于主机数。并且机构通常无需把所有主机接入外部互联网，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

- VPN是在公用网络上建立专用网络的技术。之所以称虚拟网，是因为整个VPN网络的任意节点间的连接并没有传统专网所需的端到端的物理链路，而是架构在公用网络服务商所提供的网络平台。

### 网络地址转换 NAT

- 专用网内部主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。
- 主要实现功能：数据包伪装、平衡负载、端口转发和透明代理。
- 基本工作原理：当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP间转换。

### 路由

- 路由器从功能上划分为：**路由选择**和**分组转发**。
  - 分组转发结构由三部分组成：交换结构、一组输入端口和一组输出端口。

#####路由选择

- 路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。
- 互联网划分为许多较小的自治系统 AS，一个 AS 可以使用和别的 AS 不同的路由选择协议。

- 路由选择协议分两大类：
  - 内部网关协议，自治系统内部的路由选择：RIP 和 OSPF.
  - 外部网关协议，自治系统间的路由选择：BGP.

#####分组转发

1. 首先从IP数据报首部提取出目的主机的IP地址D，得出其所在的网络N；

2. 若N是与此路由器直接相连的某个网络，则直接交付。否则就执行 `3`；

3. 若路由表中有目的地址为D的特定主机路由，则把数据报传给路由表中所指明的下一跳路由器。否则执行`4`；

4. 若路由表中有到达网络N的路由，则把数据报传给路由表中所指明的下一跳路由器。否则执行 `5`；

5. 若路由表中有一个默认路由，则把数据报传给默认路由所指明的默认路由器。否则执行`6`；

6. 报错：转发分组出错。



## 4 传输层 Transport Layer

- 网络层协议只提供了点到点的连接，而传输层协议提供一种端到端的服务，即应用进程间的通信。
- 传输层向用户屏蔽了网络层的细节，使应用程序看起来像两个传输层实体间一条端到端的逻辑通信信道。
- 为使一端发出的数据能被另一端正确的进程接收，引入了端口号。不同端口号对应于不同进程。

### 主要传输层协议

- [TCP](https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE)
- [UDP](https://zh.wikipedia.org/wiki/%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AE)

### TCP协议

- TCP即传输控制协议，是一个**可靠**的、面向连接的协议。
- 允许网络间两台主机之间**无差错**的信息传输。
- TCP协议进行流量控制，以避免**拥塞**。
- TCP协议**效率较低，但可靠性高。**适合于网络链路不好或可靠性要求高的环境。
- 每一条 TCP 连接只能是点对点的（一对一）。

##### 首部格式

![TCP首部](<https://raw.githubusercontent.com/DuskPiper/ProjChengdu-Coder-Notes/master/Illustration/TCP%E9%A6%96%E9%83%A8.png>)



- 源端口与目标端口：分别是源端口号和目标端口号。
- 序号：当前TCP数据段发送的第一个字节在直接流中的序号，范围$[0, 2^{32} - 1]$。
- 确认号：期望收到的下一个报文段的序号。即：当前报文段序号 + 当前数据长度 + 1 。
- 数据偏移：数据部分距报文段起始处的偏移量，实际上指首部的长度。
- 紧急指针标志 URG： `URG = 1` 时有效。它告知系统有紧急数据，应尽快传送，此时会将紧急数据插入到本报文段数据的最前。
- 确认 ACK： `ACK = 1` 时有效。按规定连接建立后所有报文段 `ACK` 都须置 1。
- 重置 RST： `RST = 1` 时有效，表明TCP连接出现严重错误，此时必须释放连接，之后重新连接。
- 同步 SYN：建立连接时用来同步序号。当 `SYN = 1`，`ACK = 0` 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 `SYN = 1`，`ACK = 1` 。
- 终止 FIN：用来释放一个连接， `FIN = 1` 表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- 窗口：窗口值作为接收方让发送方设置其发送窗口的依据。是考虑到接收方的数据缓存空间有限而设置的。
- 紧急指针：仅当 `URG=1` 时才有效，指出紧急数据的字节数。

##### 三次握手 Three-way Handshake

- 概述：建立一个 TCP 连接时，客户端和服务器共发送3个包。在 socket 编程中，客户端执行 `connect()` 时，将触发三次握手。

- 原因：为防止失效连接请求到达服务器，让服务器错误地为其打开连接。

- 内容：

  - 第一次握手(`SYN = 1, seq = x`):

    客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，及初始序号 `X`，保存在包头的序列号(Sequence Number)字段里。

    发送完毕后，客户端进入 `SYN_SEND` 状态。

  - 第二次握手(`SYN = 1, ACK = 1, seq = y, ACKnum = x + 1`):

    服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即 `X+1`。发送完毕后，服务器端进入 `SYN_RCVD` 状态。

  - 第三次握手(`ACK = 1, ACKnum = y + 1`)

    客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1

    发送完毕后，客户端进入 `ESTABLISHED` 状态，当服务器端接收到这个包时，也进入 `ESTABLISHED`状态，TCP 握手结束。

- 示意图：

  ![TCP 三次握手](<https://raw.githubusercontent.com/HIT-Alibaba/interview/master/img/tcp-connection-made-three-way-handshake.png>)

##### 四次握手(挥手) Four-way handshake

- 概述：TCP连接的拆除共发送4个包。客户端或服务器均可主动发起握手动作。在 socket 编程中，任何一方执行 `close()` 操作都可触发四次握手。

- 原因：客户端发送了 `FIN` 连接释放报文之后，服务器收到这个报文，就进入了 `CLOSE-WAIT` 状态。这个状态是为让服务器端发送还未传送完毕的数据。一旦传送完毕，服务器会发送 FIN 连接释放报文。

- 内容：

  - 第一次挥手(`FIN = 1, seq = x`)

    客户端想要关闭连接，发送一个 `FIN` 标志位置为1的包，表示已无数据发送，但仍可接受数据。

    发送完毕后，客户端进入 `FIN_WAIT_1` 状态。

  - 第二次挥手(`ACK = 1, ACKnum = x + 1`)

    服务器端确认客户端的 `FIN` 包，并发送一个确认包，表明收到了请求，但尚未准备好关闭连接。

    发送完毕后，服务器端进入 `CLOSE_WAIT` 状态。客户端收到确认包之后，进入 `FIN_WAIT_2` 状态，等待服务器端关闭连接。

  - 第三次挥手(`FIN = 1, seq = y`)

    服务器端准备好关闭连接时，向客户端发送结束连接请求，`FIN` 置 `1`。

    发送完毕后，服务器端进入 `LAST_ACK` 状态，等待来自客户端的最后一个 `ACK`。

  - 第四次挥手(`ACK = 1, ACKnum = y + 1`)

    客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 `TIME_WAIT`状态，等待可能出现的要求重传的 ACK 包。

    服务器端接收到这个确认包之后，关闭连接，进入 `CLOSED` 状态。

    客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 `CLOSED` 状态。

##### 可靠性保证

- TCP 使用超时重传实现可靠传输：如某已经发送的报文段在超时时间内未收到确认，则重传该报文段。

##### 滑动窗口

- 窗口是缓存的一部分，用来暂存部分字节流。发送方和接收方各有一个窗口，接收方通过窗口字段告知发送方自己窗口大小，发送方参考这个值设置自己窗口大小。
- 发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如发送窗口左部的字节已发送并收到确认，则将窗口右滑一定距离，直到左部第一个字节不是"已发送且已确认"的状态；接收窗口类似，如窗口左部字节已发送确认并交付主机，则向右滑动窗口。
- 接收方只对其窗口内最后一个按序到达的**字节**进行确认。发送方得到一个字节的确认，就知道此字节之前所有字节都已被接收。

#####流量控制

- 控制发送方发送速率，保证接收方来得及接收。

- 接收方发送的确认报文中的窗口字段可用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 `0`，则发送方不能发送数据。

#####TCP 拥塞控制

- 如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，加重网络拥塞程度。
- 当出现拥塞时，应当控制发送方的速率以降低网络拥塞度。这一手段类似流量控制，但目的不同。

[![img](https://camo.githubusercontent.com/e39821d9ef5a84cde382c28945e9ab9b524ddd42/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f35316532656439352d363562382d346165392d386166332d3635363032643435326132352e6a7067)](https://camo.githubusercontent.com/e39821d9ef5a84cde382c28945e9ab9b524ddd42/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f35316532656439352d363562382d346165392d386166332d3635363032643435326132352e6a7067)

- 四种拥塞控制手段：慢开始、拥塞避免、快重传、快恢复。

- 发送方需维护一个叫做拥塞窗口(cwnd)的**状态变量**，但实际决定发送方能发送多少数据的是发送方窗口。

#####SYN攻击

- 攻击客户端短时间伪造大量IP地址，向服务器不断发送SYN包，服务器回复确认包并等待确认。由于源IP地址是虚假的，服务器需要不断重发直至超时。这些伪造的SYN包长时间占用未连接队列，正常SYN请求被丢弃，导致目标系统运行缓慢，甚至引起网络堵塞甚至系统瘫痪。
- SYN 攻击是一种典型的 DoS/DDoS 攻击。
- SYN攻击无法完全阻止，除非另起协议。能做的是尽可能减轻SYN攻击的危害。

##### TCP KeepAlive

- 问题：在长时间无数据交互的时间段内，双方可能出现掉电、死机、异常重启等意外。意外发生后，TCP 连接未正常释放，在软件层面上，对方不知晓异常，则会一直维护当前连接。长时间积累导致大量半打开连接，造成系统资源消耗和浪费。
- 解决：(在传输层)隔一段时间给连接对端发送探测包，如收到对方回应的 ACK 则认为连接尚且存活。如超过一定重试次数后一直未收到对方回应，则丢弃该 TCP 连接。

### UDP协议

- UDP即用户数据报协议，它采用**无连接的方式**传送数据。
- 送端不关心发送的数据是否到达目标主机、数据是否出错。收到数据的主机也不会告知发送方。
- 可靠性由上层协议来保障。尽最大可能交付，没有拥塞控制。
- UDP协议**效率较高，但可靠性低。**常用于一些实时业务，也用于对差错不敏感的应用。
- 支持一对一、一对多、多对一和多对多的交互通信。

##### 首部格式

- 首部字段仅8字节，包括源端口、目的端口、长度、检验和。12字节的伪首部是为了计算检验和。

![UDP首部](https://camo.githubusercontent.com/13154ad44f13803ca994ed78dfb7a01a6ae684b1/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f64346333613461312d303834362d343665632d396363332d6561646466636137313235342e6a7067)



##5 应用层 Application Layer

### 域名系统

- DNS：一个分布式数据库，提供主机名和 IP 地址间相互转换的服务。"分布式"指每个站点仅保留自己那部分数据。

- 域名的层次结构：从上到下为

  - 根域名：域名空间最顶层，一般用 `.` 表示。一个根服务器名字可作为入口对应一组(遍布全球的)服务器集群来提供域名解析服务。
  - 顶级域名：标明一种类型的组织机构或地区，如 `.net`, `.com`, ` .gov`, ` .cn` 。
  - 二级域名：标明顶级域内一个特定的组织，如`.com.cn`, `.edu.cn` 。

  ![域名层次](<https://pic2.zhimg.com/80/v2-59cf070e13da779b42fa6780bdbece01_hd.jpg>)

- 域名传输：DNS 可使用 UDP 或 TCP 传输，端口号都为 `53`。通常使用 UDP 传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传。在两种情况下会使用 TCP 进行传输：
  - 如果返回的响应超过 512 字节(UDP 最大只支持 512 字节)。
  - 区域传送(主域名服务器向辅助域名服务器传送变化的那部分数据)。

### 文件传送协议 FTP

- 用途：用于在计算机网络上在客户端和服务器间进行文件传输的应用层协议
- 使用TCP连接。
- FTP 需要两个连接来传送一个文件：
  - 控制连接：服务器打开端口 `21` 等待客户端连接，客户端主动连接后将命令传送给服务器，并传回应答。
  - 数据连接：用来传送一个文件数据。
- 主动和被动模式：根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式。
  - 主动模式：服务器端主动建立数据连接。服务器端端口号 `20`，客户端端口号随机但须大于 `1024` 以避开熟知端口号。
  - 被动模式：客户端主动建立数据连接。其中客户端端口号由客户端自己指定，服务器端的端口号随机。

### 动态主机配置协议 DHCP

- 用途：该协议允许服务器向客户端动态分配 IP 地址和配置信息。

- DHCP 服务器至少向客户端提供：IP 地址、子网掩码、默认网关。还可提供其他信息，如 DNS 服务器地址。

- DHCP服务器为客户端分配IP地址有三种形式：

  - 将一个IP地址固定分配给一个客户端。

  - 随机将地址永久性分配给客户端。

  - (常见形式)随机将地址分配给客户端使用一段时间。

###远程登录协议 Telnet

- 是Internet远程登录服务的标准协议和主要方式。
- 用途：为用户提供了在本地计算机上完成远程主机工作的能力。是常用的远程控制Web服务器的方法。
- 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。

###电子邮件协议 

- 常用有SMTP, POP3, IMAP4，均属于TCP/IP协议簇。默认分别通过TCP端口 `25`, `110`, `143` 建立连接。

##### SMTP 协议

- 全称是“Simple Mail Transfer Protocol”，即简单邮件传输协议。
- SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并未改动或取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。

#####POP3 协议

- 特点是只要用户从服务器上读取了邮件，就把该邮件删除。

##### IMAP 协议

- 客户端和服务器上的邮件保持同步，如不手动删除邮件则服务器上的邮件也不会被删除。让用户能随时随地访问服务器上的邮件。

### 常用端口

| 应用             | 应用层协议 | 端口号        | 传输层协议 | 备注                         |
| ---------------- | ---------- | ------------- | ---------- | ---------------------------- |
| 域名解析         | DNS        | `53`          | UDP / TCP  | 长度超512字节时用 TCP        |
| 动态主机配置协议 | DHCP       | `67` / `68`   | UDP        |                              |
| 简单网络管理协议 | SNMP       | `161` / `162` | UDP        |                              |
| 文件传送协议     | FTP        | `20` / `21`   | TCP        | 控制连接 `21`，数据连接 `20` |
| 远程终端协议     | TELNET     | `23`          | TCP        |                              |
| 超文本传送协议   | HTTP       | `80`          | TCP        |                              |
| 简单邮件传送协议 | SMTP       | `25`          | TCP        |                              |
| 邮件读取协议     | POP3       | `110`         | TCP        |                              |
| 网际报文存取协议 | IMAP       | `143`         | TCP        |                              |

### **Web 页面请求过程** (常考点)

#####1. DHCP 配置主机信息

- 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。
- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。
- 该报文段被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址(0.0.0.0)的 IP 数据报中。
- 该数据报被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。
- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。
- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

##### 2. ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。
- 主机生成一个 DNS 查询报文，该报文具有 `53` 号端口，对应 DNS 服务器的端口号。
- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。
- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。
- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。
- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。
- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

##### 3. DNS 域名解析

- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。
- 网关路由器收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。
- 因为路由器具有内部网关协议(RIP、OSPF)和外部网关协议(BGP)这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。
- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。
- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

##### 4. HTTP 请求页面

- 有 HTTP 服务器的 IP 地址后，主机就能生成 TCP 套接字，用于向 Web 服务器发送 HTTP GET 报文。
- 生成 TCP 套接字前，须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 `80` 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。
- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。
- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。
- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。
- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容进行渲染并显示 Web 页面。



# References

- [Cyc2018/CS-Notes](<https://github.com/CyC2018/CS-Notes/blob/master/docs/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E7%9B%AE%E5%BD%95.md>)
- [Notes on the 5-Layer and 7-Layer Models of Interconnection](https://www.ischool.utexas.edu/~wyllys/ITIPMaterials/NotesOnInterconnection.html)
- [一张图了解TCP/IP五层网络模型](https://blog.csdn.net/zhshulin/article/details/62888061)
- [互联网协议入门（一） - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)
- [计算机网络原理笔记（三、数据链路层）](https://blog.csdn.net/leiflyy/article/details/50623979)
- [网络层 - WikiPedia](<https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%B1%82>)
- [地址解析协议 - WikiPedia](<https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE>)
- [网络地址转换NAT原理（易于理解）](<https://blog.csdn.net/hzhsan/article/details/45038265>)
- [路由器分组转发算法](<https://blog.csdn.net/friendan/article/details/8497037>)
- [传输层详解](<https://blog.csdn.net/qq_25843323/article/details/50471134>)
- [TCP报文段首部详解](<https://blog.csdn.net/yangbodong22011/article/details/48496717>)
- [TCP 协议 · 笔试面试知识整理](<https://hit-alibaba.github.io/interview/basic/network/TCP.html>)
- [TCP sliding window - 优酷](<https://v.youku.com/v_show/id_XNDg1NDUyMDUy.html>)
- [DNS入门：域名结构与域名服务器](<https://zhuanlan.zhihu.com/p/38282917>)
- [文件传输协议 - WikiPedia](<https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE>)
- [动态主机配置协议 - 百度百科](<https://baike.baidu.com/item/%E5%8A%A8%E6%80%81%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E5%8D%8F%E8%AE%AE>)
- [Telnet - 百度百科](<https://baike.baidu.com/item/Telnet/810597>)