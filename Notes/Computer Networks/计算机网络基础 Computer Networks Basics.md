# 计算机网络基础 Computer Networks Basics

## 概述

### ISP 互联网服务提供商

- ISP从互联网管理机构获得IP地址，拥有通信线路及路由器等联网设备，个人或机构向ISP购买服务就可接入互联网。

- 互联网是一种多层次ISP结构，ISP根据覆盖面积的大小分为第一层ISP、区域ISP和接入ISP。互联网交换点 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。

- IXP 互联网交换中心：不同电信运营商间为连通各自网络而建立的集中交换平台，一般由第三方中立运营。

  ![IXP & ISP](<https://camo.githubusercontent.com/b5bdb659b78196ccfa88909e4b9c8263d2af2cb0/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f385f323030313535303831323033383139302e706e67>)

  

### 主机间的通讯方式

- Client - Server (C/S)：客户是服务的请求方，服务器是服务的提供方。
- P2P 对等网络：每个参与者具有同等的能力，可以发起一个通信会话。[详细](https://blog.csdn.net/ljianhui/article/details/16911151)

### 时延

时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

- 排队时延：分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。
- 处理时延：主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。
- 传输时延：主机或路由器传输数据帧所需要的时间。
- 传播时延：电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。

## 体系结构

![layers](<https://camo.githubusercontent.com/307487dbeaf00492335d1f034529100e4f368a43/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f66356434306230312d616266322d343335652d396365372d3738383963343162326661362e6a7067>)

### The 5-Layer Model (the TCP/IP Model)

- **应用层 Process & Application Layer**：为特定应用程序提供数据传输服务，数据单位为报文。协议代表：<u>HTTP、DNS、WWW</u> 等。

- **传输层 Transport Layer**：为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。Unix把"主机+端口"称作Socket，由此产生两种协议：<u>TCP</u> 提供完整性服务，<u>UDP</u> 提供及时性服务。

  ​	**传输控制协议 TCP**，提供面向连接的可靠数据传输服务，数据单位为报文段；

  ​	**用户数据报协议 UDP**，提供无连接的尽最大努力的数据传输服务，数据单位为用户数据报。

- **网络层 Network Layer**：基于网络寻址协议为主机提供数据传输服务（而传输层为主机中的进程提供数据传输服务）。把传输层传递下来的报文段或用户数据报封装成分组。协议代表：<u>IP、IPX、RIP、OSPF</u>等。

- **数据链路层 Data Link Layer**：为同一链路主机提供数据传输（网络层针对的是主机间数据传输，而主机之间可以有很多链路）。数据链路层把网络层传下来的分组封装成帧。协议代表：<u>Eternet、MAC地址</u>等。

- **物理层 Physical Layer**：在传输媒介上传输数据比特流（0和1的电信号）。尽可能屏蔽传输媒介和通信手段的差异，使数据链路层感觉不到这些差异。协议代表：<u>电缆、光纤、双绞线、无线电波</u>等。

### The 7-Layer Model (the OSI Model)

OSI是Open System Interconnect的缩写，其将TCP的**应用层**拆分为三层功能：

- **会话层 Session Layer**：建立和管理进程间会话。
- **表示层 Presentation Layer**：数据压缩、加密以及数据描述，如ASCII，Unicode，BMP编解码。
- **应用层 Application Layer**：计算机操作及界面管理。



## 1 物理层 Physical Layer

###通信方式

根据信息在传输线上的传送方向，分为以下三种通信方式：

- 单工通信：单向传输；
- 半双工通信：双向交替传输；
- 全双工通信：双向同时传输。

### 带通调制

- 带通调制把数字信号转换为模拟信号。



##2 链路层 Data Link Layer

链路(link)是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

### 基本要素

#####封装成帧

- 数据链路层传输的是帧。

- 封装成帧就是在一段数据的前后分别添加**首部**和**尾部**，就构成了一个帧。

  ![封装成帧](<https://camo.githubusercontent.com/6c2bd984d53bd59f2d120e8de63b68978f1b8256/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f39633630373933662d356537662d343533622d383431332d3335383930633234616263342e706e67>)

#####透明传输

- 为了防止帧的数据部分出现混淆首部/尾部的字符 `SOH` 和 `EOT` ，传输前插入转义字符 `ESC` 标明。接收端再将该转义字符删除。
- 如果转义字符 `ESC` 本身也出现在数据部分，为了防止混淆，会在其前面再插入一个同样的字符。接收端只删除两个连续转义字符中前面的那个。

#####差错检验

- 数据链路层广泛使用循环冗余检验(CRC)来检查比特差错。

#####信道

- 点对点信道：一对一通信。不会发生碰撞，较简单。使用 PPP 协议进行控制。
- 广播信道：一对多通信，所有节点在同一个广播信道上发送数据，需要专门的控制方法进行协调，避免碰撞。主要有两种控制方法，一是**信道复用技术**，一是 **CSMA/CD 协议**。

#####信道复用

- 频分复用：所有主机在相同时间占用**不同频率**的带宽资源。
- 时分复用：所有主机在**不同时间**占用相同频率的带宽资源。
- 统计时分复用：时分复用的改进。不固定每个用户在时分复用帧中的位置，一旦有数据则集中起来组成统计时分复用帧发送。

- 波分复用：光的频分复用。因此习惯上用波长而非频率来表示所使用的光载波。

- 码分复用：为每个用户分配 m bit 的码片，并且所有的码片正交。接收端通过对数据进行内积运算确定用户身份。

  

### 通信协议

#####CSMA/CD 

- Carrier Sense Multiple Access with Collision Detection，意为载波监听多点接入/碰撞检测。
- 多点接入说明是总线型网络，计算机连接在一根总线上，技术核心是“载波监听”和“碰撞检测”。

- 思想上源于1-persistent CSMA。在其基础上加入了碰撞检测机制。

- 具体工作机制：

  **节点发送数据前持续监听信道，一旦发现信道空闲则立刻发送数据。同时也持续监听信道，探测是否别的节点当前也在发送数据。**

  **若传输过程中未检测到别的节点传输，则传输成功。成功后，节点须等待帧间间隔IFG (interframe gap) 时间后，才可以进行下一次传输。**

- 记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就知道是否发生碰撞，称 2τ 为**争用期**。经过争用期后还未检测到碰撞，则肯定这次发送不发生碰撞。
- 碰撞时站点要停止发送，等待一段时间再发送。此时间采用**截断二进制指数退避算法**确定。

#####PPP

- PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

- PPP 的帧格式：

  ![PPP帧](<https://camo.githubusercontent.com/5242826de22946936d5116633d8976b4fcac5202/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f36333031303733372d326362342d343866332d393939662d3039313934343831623232372e706e67>)

  - F 字段为帧的定界符
  - A 和 C 字段暂时没有意义
  - FCS 字段是使用 CRC 的检验序列
  - 信息部分的长度不超过 1500

#####MAC地址

- 是链路层地址，长 6 bytes (48 bits)，用于唯一标识网络适配器。
- 一台主机拥有多少个网络适配器就有多少个 MAC 地址。

#####Ethernet

- 以太网是一种星型拓扑结构局域网。

- 目前以太网使用交换机，交换机是一种链路层设备，它不会发生碰撞，能根据 MAC 地址进行存储转发。

- 以太网帧格式：

  - **类型** ：标记上层使用的协议；
  - **数据** ：长度在 46-1500 之间，如果太小则需要填充；
  - **FCS** ：帧检验序列，使用的是 CRC 检验方法；

  [![img](https://camo.githubusercontent.com/3b68f07549d9dde06f0525b71810cdfcfd6294e2/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f34323066346463302d366334622d343836632d616665612d3237343239393031343436322e706e67)](https://camo.githubusercontent.com/3b68f07549d9dde06f0525b71810cdfcfd6294e2/68747470733a2f2f67697465652e636f6d2f437943323031382f43532d4e6f7465732f7261772f6d61737465722f646f63732f706963732f34323066346463302d366334622d343836632d616665612d3237343239393031343436322e706e67)

#####交换机

- 交换表中存储 MAC 地址到接口的映射。
- 交换机具有自学习能力，学习的是交换表的内容。因此交换机是即插即用的，不需要手动配置交换表内容。

#####虚拟局域网

- 建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。



##3 网络层 Network Layer

网络层是整个互联网的核心，应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

网络层提供[路由](https://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1)和寻址的功能，使两终端系统能互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。由于TCP/IP协议体系中的网络层功能由IP协议规定和实现，故又称IP层。网络层也是[TCP/IP](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)模型中的网际层。

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

### IP报文

IP报文是在网络层传输的数据单元，也叫IP数据报。

![IP 数据报](<https://raw.githubusercontent.com/DuskPiper/ProjChengdu-Coder-Notes/master/Illustration/IP%20%E6%95%B0%E6%8D%AE%E6%8A%A5.png>)

- **版本** : 有 4（IPv4）和 6（IPv6）两个值；
- **首部长度** : 占 4 位，最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为首部固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
- **区分服务** : 用来获得更好的服务，一般情况下不使用。
- **总长度** : 包括首部长度和数据部分长度。
- **生存时间** ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
- **协议** ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
- **首部检验和** ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- **标识** : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- **片偏移** : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

### IP地址编址

IP 地址的编址方式经历了三个历史阶段：

- 分类：由两部分组成，网络号和主机号。其中不同分类具有不同的网络号长度，并且固定。
- 子网划分：在主机号中取一部分作子网号，从而把两级 IP 地址划分为三级 IP 地址。须配置子网掩码。
- **无分类**：无分类编址 CIDR 使用网络前缀和主机号进行编码，网络前缀长度可按需变化。记法上采用在完整 IP 地址后加上网络前缀长度的方法。

###地址解析协议 ARP

- ARP 实现由 IP 地址得到 MAC 地址。是通过解析网路层地址来找寻数据链路层地址(MAC地址)的、一个在网络协议包中极其重要的网络传输协议。
- 每个主机都有一个 ARP 高速缓存，存有本局域网上的各主机和路由器 IP 地址到 MAC 地址的映射表。
- 在[IPv6](https://zh.wikipedia.org/wiki/IPv6)中[邻居发现协议](https://zh.wikipedia.org/wiki/%E9%82%BB%E5%B1%85%E5%8F%91%E7%8E%B0%E5%8D%8F%E8%AE%AE)（NDP）用于代替地址解析协议。

### 网际控制报文协议 ICMP

- ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。
- 它封装在 IP 数据报中，是TCP/IP协议族的一个子协议，但不属于高层协议。

#####Ping

- Ping 是 ICMP 的一个重要应用，用于测试两主机间的连通性。
- 向目的主机发送 ICMP Echo 请求报文，目的主机收到后发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算数据包往返时间以及丢包率。

#####Traceroute

- Traceroute 是 ICMP 的一个重要应用，用于跟踪一个分组从源点到终点的路径。
- 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

### 虚拟专用网 VPN

- 由于 IP 地址紧缺，一个机构分配的 IP 地址数往往远小于主机数。并且机构通常无需把所有主机接入外部互联网，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

- VPN是在公用网络上建立专用网络的技术。之所以称虚拟网，是因为整个VPN网络的任意节点间的连接并没有传统专网所需的端到端的物理链路，而是架构在公用网络服务商所提供的网络平台。

### 网络地址转换 NAT

- 专用网内部主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。
- 主要实现功能：数据包伪装、平衡负载、端口转发和透明代理。
- 基本工作原理：当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP间转换。

### 路由

- 路由器从功能上划分为：**路由选择**和**分组转发**。
  - 分组转发结构由三部分组成：交换结构、一组输入端口和一组输出端口。

#####路由选择

- 路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。
- 互联网划分为许多较小的自治系统 AS，一个 AS 可以使用和别的 AS 不同的路由选择协议。

- 路由选择协议分两大类：
  - 内部网关协议，自治系统内部的路由选择：RIP 和 OSPF.
  - 外部网关协议，自治系统间的路由选择：BGP.

#####分组转发

1. 首先从IP数据报首部提取出目的主机的IP地址D，得出其所在的网络N；

2. 若N是与此路由器直接相连的某个网络，则直接交付。否则就执行 `3`；

3. 若路由表中有目的地址为D的特定主机路由，则把数据报传给路由表中所指明的下一跳路由器。否则执行`4`；

4. 若路由表中有到达网络N的路由，则把数据报传给路由表中所指明的下一跳路由器。否则执行 `5`；

5. 若路由表中有一个默认路由，则把数据报传给默认路由所指明的默认路由器。否则执行`6`；

6. 报错：转发分组出错。







# References

- [Cyc2018/CS-Notes](<https://github.com/CyC2018/CS-Notes/blob/master/docs/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E7%9B%AE%E5%BD%95.md>)
- [Notes on the 5-Layer and 7-Layer Models of Interconnection](https://www.ischool.utexas.edu/~wyllys/ITIPMaterials/NotesOnInterconnection.html)
- [一张图了解TCP/IP五层网络模型](https://blog.csdn.net/zhshulin/article/details/62888061)
- [互联网协议入门（一） - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)
- [计算机网络原理笔记（三、数据链路层）](https://blog.csdn.net/leiflyy/article/details/50623979)
- [Wikipedia - 网络层](<https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%B1%82>)
- [Wikipedia - 地址解析协议](<https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE>)
- [网络地址转换NAT原理（易于理解）](<https://blog.csdn.net/hzhsan/article/details/45038265>)
- [路由器分组转发算法](<https://blog.csdn.net/friendan/article/details/8497037>)